{{ define "main" }}
<div class="container-xxl single-txt">
	<div class="row g-5">
		<div id="gallery" class="col-lg-4 partie">
			<a data-pswp-width="900" class="border-radius" data-pswp-height="1273" target="_blank" href="/shop/images/{{ with .Params.thumbnail }}{{ .}}{{ end }}">
      			<img src="/shop/images/{{ with .Params.thumbnail }}{{ .}}{{ end }}" class="img-fluid border-radius mb-4" alt="{{ with .Params.alt }}{{ .}}{{ end }}"/>
			</a>
			{{ with .Params.images_multiple}}
			<div class="d-flex justify-content-start">
				{{ range . }}
					<div class="col-lg-3 me-4">
						<a data-pswp-width="900" class="border-radius" data-pswp-height="1273" target="_blank" href="/shop/images/{{.image_multiple}}">
							<img src="/shop/images/{{.image_multiple}}" class="img-fluid mb-3" style="border-radius: 8px;" alt="{{.alt_gallery}}"/>
						</a>
						</div>
				{{end}}
			</div>
			{{end}}
		</div>
		<div class="col-lg-6 offset-lg-2">
			<a class="back mt-3" href="/shop" target="_self">retour shop</a>
      <h1 class="mt-3 mb-3">{{.Title}}</h1>
			{{ with .Params.size }}
				<p class="border-top-custom date pt-3 mt-3 mb-5">{{.}}</p>
			{{ end }}
			{{ .Content | safeHTML }}
			<div class="product-purchase">
			{{ with .Params.price }}
        <p class="price border-top-custom pt-5 mt-5 mb-3">{{.}}€</p>
      {{ end }}
		 {{ if .Params.stripe_price_id }}
          <div class="purchase-section" 
               data-stock="{{ .Params.stock | default 0 }}"
               data-price-id="{{ .Params.stripe_price_id }}"
               data-product-name="{{ .Title }}"
               data-price="{{ .Params.price }}">
            
            <!-- Indicateur de stock -->
            <div class="stock-info">
              {{ if gt (.Params.stock | default 0) 0 }}
                {{ if le (.Params.stock | default 0) 5 }}
                  <span class="stock-low">Plus que {{ .Params.stock }} en stock !</span>
                {{ else }}
                  <span class="stock-available">{{ .Params.stock }} en stock</span>
                {{ end }}
              {{ else }}
                <span class="stock-unavailable">Rupture de stock</span>
              {{ end }}
            </div>

            <!-- Sélecteur de quantité -->
            <div class="quantity-selector">
              <label for="quantity">Quantité :</label>
              <select id="quantity" name="quantity">
                <!-- Options générées par JavaScript selon le stock -->
              </select>
            </div>
            
            <!-- Boutons d'action -->
            <div class="product-actions">
              <button id="add-to-cart-btn" class="btn btn-secondary">
                Ajouter au panier
              </button>
              <button id="buy-now-btn" class="btn btn-primary">
                Acheter maintenant
              </button>
            </div>
          </div>
        {{ else }}
          <div class="not-available">
            <p>Produit temporairement indisponible</p>
            <p><small>Ce produit n'est pas encore synchronisé avec Stripe.</small></p>
          </div>
        {{ end }}
			</div>
      <div class="toast-container" id="toast-container"></div>
		</div>
	</div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Récupérer les données depuis les attributs HTML
  var purchaseSection = document.querySelector('.purchase-section');
  
  if (!purchaseSection) {
    console.log('Section d\'achat non trouvée - produit probablement indisponible');
    return;
  }
  
  var stock = parseInt(purchaseSection.getAttribute('data-stock')) || 0;
  var priceId = purchaseSection.getAttribute('data-price-id');
  var productName = purchaseSection.getAttribute('data-product-name');
  var price = parseFloat(purchaseSection.getAttribute('data-price'));
  
  var quantitySelect = document.getElementById('quantity');
  var addToCartBtn = document.getElementById('add-to-cart-btn');
  var buyNowBtn = document.getElementById('buy-now-btn');
  
  console.log('Initialisation produit:', {
    name: productName,
    stock: stock,
    price: price,
    priceId: priceId
  });

  // Fonctions Toast
  function createToastContainer() {
    var container = document.getElementById('toast-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'toast-container';
      container.className = 'toast-container';
      document.body.appendChild(container);
    }
    return container;
  }

  function showToast(message, type) {
    var container = createToastContainer();
    var toastId = 'toast-' + Date.now();
    
    var iconMap = {
      success: '✓ Succès',
      error: '⚠ Erreur',
      warning: '⚠ Attention'
    };
    
    var toastHtml = '<div id="' + toastId + '" class="toast toast-' + type + '">' +
      '<div class="toast-header">' +
        '<strong class="me-auto">' + (iconMap[type] || '• Info') + '</strong>' +
        '<button type="button" class="toast-close" onclick="hideToast(\'' + toastId + '\')">&times;</button>' +
      '</div>' +
      '<div class="toast-body">' + message + '</div>' +
    '</div>';
    
    container.insertAdjacentHTML('beforeend', toastHtml);
    
    var toast = document.getElementById(toastId);
    
    setTimeout(function() {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(function() {
      hideToast(toastId);
    }, 4000);
  }

  window.hideToast = function(toastId) {
    var toast = document.getElementById(toastId);
    if (toast) {
      toast.classList.remove('show');
      setTimeout(function() {
        if (toast.parentNode) {
          toast.remove();
        }
      }, 300);
    }
  };

  // Générer les options de quantité selon le stock
  function initializeQuantitySelector() {
    if (!quantitySelect) return;
    
    quantitySelect.innerHTML = '';
    
    if (stock > 0) {
      var maxQuantity = Math.min(stock, 10);
      
      for (var i = 1; i <= maxQuantity; i++) {
        var option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        quantitySelect.appendChild(option);
      }
    } else {
      var option = document.createElement('option');
      option.value = 0;
      option.textContent = 'Indisponible';
      quantitySelect.appendChild(option);
      quantitySelect.disabled = true;
    }
  }

  // Désactiver les boutons si pas de stock
  function updateButtonStates() {
    if (stock <= 0) {
      if (addToCartBtn) {
        addToCartBtn.disabled = true;
        addToCartBtn.textContent = 'Rupture de stock';
      }
      if (buyNowBtn) {
        buyNowBtn.disabled = true;
        buyNowBtn.textContent = 'Indisponible';
      }
      return false;
    }
    return true;
  }

  // Initialiser l'interface
  initializeQuantitySelector();
  var buttonsEnabled = updateButtonStates();

  if (!buttonsEnabled) {
    return; // Arrêter ici si pas de stock
  }

  // Bouton Ajouter au panier avec vérification stock
  if (addToCartBtn) {
    addToCartBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      var selectedQuantity = quantitySelect ? parseInt(quantitySelect.value) : 1;
      
      if (!priceId) {
        showToast('Erreur: Produit non configuré dans Stripe', 'error');
        return;
      }
      
      if (selectedQuantity <= 0 || selectedQuantity > stock) {
        showToast('Quantité invalide (stock disponible: ' + stock + ')', 'error');
        return;
      }
      
      // Vérifier le stock dans le panier existant
      var cart = JSON.parse(localStorage.getItem('cart') || '[]');
      var existingItem = null;
      
      for (var i = 0; i < cart.length; i++) {
        if (cart[i].priceId === priceId) {
          existingItem = cart[i];
          break;
        }
      }
      
      var totalInCart = existingItem ? existingItem.quantity : 0;
      
      if (totalInCart + selectedQuantity > stock) {
        var available = stock - totalInCart;
        if (available <= 0) {
          showToast('Ce produit est déjà dans votre panier (stock épuisé)', 'error');
        } else {
          showToast('Stock insuffisant. Vous pouvez encore ajouter ' + available + ' exemplaire(s)', 'warning');
        }
        return;
      }
      
      // Ajouter au panier si stock OK
      if (existingItem) {
        existingItem.quantity += selectedQuantity;
      } else {
        cart.push({
          priceId: priceId,
          productName: productName,
          price: price,
          quantity: selectedQuantity
        });
      }
      
      localStorage.setItem('cart', JSON.stringify(cart));
      
      var quantityText = selectedQuantity === 1 ? '' : ' (' + selectedQuantity + ')';
      showToast(productName + quantityText + ' ajouté au panier !', 'success');
      
      // Mettre à jour le compteur global
      if (typeof updateCartCount === 'function') {
        updateCartCount();
      }
    });
  }

  // Bouton Acheter maintenant
  if (buyNowBtn) {
    buyNowBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      var selectedQuantity = quantitySelect ? parseInt(quantitySelect.value) : 1;
      
      if (!priceId) {
        showToast('Erreur: Produit non configuré dans Stripe', 'error');
        return;
      }
      
      if (selectedQuantity <= 0 || selectedQuantity > stock) {
        showToast('Quantité invalide (stock disponible: ' + stock + ')', 'error');
        return;
      }
      
      // Désactiver le bouton pendant le traitement
      e.target.disabled = true;
      var originalText = e.target.textContent;
      e.target.textContent = 'Redirection vers Stripe...';
      
      // Créer la session de paiement
      fetch('/.netlify/functions/create-checkout-session', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          priceId: priceId,
          quantity: selectedQuantity,
          successUrl: window.location.origin + '/success?product=' + encodeURIComponent(productName),
          cancelUrl: window.location.href
        })
      })
      .then(function(response) {
        if (!response.ok) {
          throw new Error('Erreur réseau: ' + response.status);
        }
        return response.json();
      })
      .then(function(data) {
        if (data.url) {
          // Rediriger vers Stripe
          window.location.href = data.url;
        } else if (data.error) {
          throw new Error(data.error);
        } else {
          throw new Error('URL de paiement non reçue');
        }
      })
      .catch(function(error) {
        console.error('Erreur achat direct:', error);
        showToast('Erreur: ' + error.message, 'error');
        
        // Réactiver le bouton
        e.target.disabled = false;
        e.target.textContent = originalText;
      });
    });
  }

  // Initialiser le compteur de panier si la fonction existe
  if (typeof updateCartCount === 'function') {
    updateCartCount();
  }
});
</script>
{{ end }}
