{{ define "main" }}
<div class="container-xxl single-txt">
	<div class="row g-5">
		<div id="gallery" class="col-lg-4 partie">
			<a data-pswp-width="900" class="border-radius" data-pswp-height="1273" target="_blank" href="/shop/images/{{ with .Params.thumbnail }}{{ .}}{{ end }}">
      			<img src="/shop/images/{{ with .Params.thumbnail }}{{ .}}{{ end }}" class="img-fluid border-radius mb-4" alt="{{ with .Params.alt }}{{ .}}{{ end }}"/>
			</a>
			{{ with .Params.images}}
			<div class="d-flex justify-content-start">
				{{ range . }}
					<div class="col-lg-3 me-4">
						<a data-pswp-width="900" class="border-radius" data-pswp-height="1273" target="_blank" href="/shop/images/{{.image}}">
							<img src="/shop/images/{{.image}}" class="img-fluid mb-3" style="border-radius: 8px;" alt="{{.alt_gallery}}"/>
						</a>
						</div>
				{{end}}
			</div>
			{{end}}
		</div>
		<div class="col-lg-6 offset-lg-2">
			<a class="back mt-3" href="/shop" target="_self">retour shop</a>
      <h1 class="mt-3 mb-3">{{.Title}}</h1>
			{{ with .Params.size }}
				<p class="border-top-custom date pt-3 mt-3 mb-5">{{.}}</p>
			{{ end }}
			{{ .Content | safeHTML }}
			<div class="product-purchase">
			{{ with .Params.price }}
        		<p class="price border-top-custom pt-5 mt-5 mb-3">{{.}}‚Ç¨</p>
      		{{ end }}
		 {{ if .Params.stripe_price_id }}
          <div class="purchase-section">
            <div class="quantity-selector">
              <label for="quantity">Quantit√© :</label>
              <select id="quantity" name="quantity">
                {{ range seq 1 10 }}
                  <option value="{{ . }}">{{ . }}</option>
                {{ end }}
              </select>
            </div>
            
            <button 
              id="checkout-button" 
              class="btn-global"
              data-price-id="{{ .Params.stripe_price_id }}"
              data-product-name="{{ .Title }}"
            >
              Acheter maintenant
            </button>
          </div>
        {{ else }}
          <p class="not-available">Produit temporairement indisponible</p>
        {{ end }}
			<p class="price">{{ .Params.price }}{{ if .Params.currency }} {{ .Params.currency }}{{ end }}</p>
				<a href="/checkout?shop={{ .File.BaseFileName }}" class="btn-global">Ajouter au panier</a>
			</div>
		</div>
	</div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const button = document.getElementById('checkout-button');
  
  if (button) {
    button.addEventListener('click', async function(e) {
      console.log('üõí Clic sur acheter');
      
      const priceId = e.target.dataset.priceId;
      const productName = e.target.dataset.productName;
      
      console.log('üì¶ Price ID:', priceId);
      
      if (!priceId) {
        alert('Erreur: Produit non configur√©');
        return;
      }
      
      button.disabled = true;
      button.textContent = 'Redirection...';
      
      try {
        const response = await fetch('/.netlify/functions/create-checkout-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            priceId: priceId,
            quantity: 1,
            successUrl: window.location.origin + '/success?product=' + encodeURIComponent(productName),
            cancelUrl: window.location.href
          })
        });
        
        console.log('üì° Response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('‚ùå Erreur HTTP:', errorText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('üì¶ Data:', data);
        
        if (data.url) {
          console.log('‚úÖ Redirection vers Stripe');
          window.location.href = data.url;
        } else {
          throw new Error('Pas d\'URL de paiement re√ßue');
        }
        
      } catch (error) {
        console.error('üö® Erreur:', error);
        alert('Erreur: ' + error.message);
        button.disabled = false;
        button.textContent = 'Acheter maintenant';
      }
    });
  }
});
</script>
{{ end }}
