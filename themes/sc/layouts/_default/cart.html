{{ define "main" }}
<div class="cart-page">
  <div class="container-xxl single-txt">
    <h1 class="mb-5">Votre Panier</h1>
    
    <div id="cart-empty" class="empty-cart" style="display: none;">
      <p class="border-top-custom">Votre panier est vide</p>
      <a href="/shop" class="btn-global mt-5">Continuer mes achats</a>
    </div>
    
    <div id="cart-content" style="display: none;">
      <div id="cart-items"></div>
      
      <div class="cart-summary d-flex justify-content-end align-items-center">
        <div class="cart-total me-5">
          <strong>Total: <span id="cart-total">0.00 €</span></strong>
        </div>
        <div class="cart-actions">
          <button onclick="showClearCartModal()" class="btn-global-secondary">Vider le panier</button>
          <button onclick="checkoutCart()" class="btn-global">Passer commande</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Modal de confirmation pour vider le panier -->
<div id="clearCartModal" class="modal-overlay">
  <div class="modal-dialog">
    <div class="modal-header">
      <h2 class="modal-title">Confirmer la suppression</h2>
      <button type="button" class="modal-close" onclick="hideClearCartModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p>Êtes-vous sûr de vouloir vider votre panier ? Cette action est irréversible.</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="modal-btn btn-global-secondary modal-btn-secondary" onclick="hideClearCartModal()">
        Annuler
      </button>
      <button type="button" class="modal-btn btn-global modal-btn-danger" onclick="confirmClearCart()">
        Vider le panier
      </button>
    </div>
  </div>
</div>
<script>
// Gestion du panier
let cart = JSON.parse(localStorage.getItem('cart') || '[]');

function updateCartDisplay() {
  const emptyDiv = document.getElementById('cart-empty');
  const contentDiv = document.getElementById('cart-content');
  const itemsContainer = document.getElementById('cart-items');
  const totalElement = document.getElementById('cart-total');
  
  if (cart.length === 0) {
    emptyDiv.style.display = 'block';
    contentDiv.style.display = 'none';
    return;
  }
  
  emptyDiv.style.display = 'none';
  contentDiv.style.display = 'block';
  
  let total = 0;
  let html = '';
  
  cart.forEach((item, index) => {
    const itemTotal = item.price * item.quantity;
    total += itemTotal;
    
    html += `
      <div class="cart-item">
        <div class="item-info">
          <h2>${item.productName}</h2>
          <p class="item-price">${item.price.toFixed(2)} € × ${item.quantity}</p>
        </div>
        <div class="item-controls">
          <input type="number" min="1" value="${item.quantity}" 
                 onchange="updateQuantity(${index}, this.value)">
          <span class="item-total">${itemTotal.toFixed(2)} €</span>
          <button onclick="removeItem(${index})" class="btn btn-danger">×</button>
        </div>
      </div>
    `;
  });
  
  itemsContainer.innerHTML = html;
  totalElement.textContent = total.toFixed(2) + ' €';
}

function updateQuantity(index, newQuantity) {
  const quantity = parseInt(newQuantity);
  if (quantity > 0) {
    cart[index].quantity = quantity;
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartDisplay();
    updateCartCount();
  }
}

function removeItem(index) {
  cart.splice(index, 1);
  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartDisplay();
  updateCartCount();
}

// Nouvelle fonction pour afficher la modal
function showClearCartModal() {
  var modal = document.getElementById('clearCartModal');
  modal.classList.add('show');
  
  // Empêcher le scroll de la page en arrière-plan
  document.body.style.overflow = 'hidden';
}

// Fonction pour masquer la modal
function hideClearCartModal() {
  var modal = document.getElementById('clearCartModal');
  modal.classList.remove('show');
  
  // Réactiver le scroll
  document.body.style.overflow = '';
}

// Fonction de confirmation pour vider le panier
function confirmClearCart() {
  cart = [];
  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartDisplay();
  updateCartCount();
  hideClearCartModal();
  
  // Optionnel : afficher une notification de succès
  showToast('Panier vidé avec succès', 'success');
}

// Fermeture de la modal en cliquant sur l'overlay
document.addEventListener('DOMContentLoaded', function() {
  var modal = document.getElementById('clearCartModal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        hideClearCartModal();
      }
    });
  }
  
  // Fermeture avec la touche Échap
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      hideClearCartModal();
    }
  });
});

async function checkoutCart() {
  if (cart.length === 0) return;
  
  const lineItems = cart.map(item => ({
    priceId: item.priceId,
    quantity: item.quantity
  }));
  
  try {
    const response = await fetch('/.netlify/functions/create-checkout-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        lineItems: lineItems,
        successUrl: `${window.location.origin}/success`,
        cancelUrl: `${window.location.origin}/cart`
      })
    });
    
    const data = await response.json();
    if (data.url) {
      window.location.href = data.url;
    } else {
      alert('Erreur lors de la création de la session de paiement');
    }
  } catch (error) {
    console.error('Erreur:', error);
    alert('Une erreur est survenue');
  }
}

// Initialiser l'affichage au chargement
document.addEventListener('DOMContentLoaded', function() {
  updateCartDisplay();
});
</script>
{{ end }}