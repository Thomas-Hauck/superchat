{{ define "main" }}
<div class="cart-page single-txt">
  <div class="container">
    <h1 class="border-bottom-custom pb-3">Votre Panier</h1>
    
    <div id="cart-empty" class="empty-cart" style="display: none;">
      <p>Votre panier est vide</p>
      <a href="/shop" class="btn-global">Continuer mes achats</a>
    </div>
    
    <div id="cart-content" style="display: none;">
      <div id="cart-items"></div>
      
      <div class="cart-summary d-flex flex-row-reverse align-items-center mt-5">
        <div class="cart-total">
          <strong>Total: <span id="cart-total">0.00 €</span></strong>
        </div>
        
        <div class="cart-actions">
          <button onclick="showClearCartModal()" class="btn-global-secondary me-2">Vider le panier</button>
          <button onclick="checkoutCart()" class="btn-global me-4" id="checkout-btn">Passer commande</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmation pour vider le panier -->
<div id="clearCartModal" class="modal-overlay">
  <div class="modal-dialog">
    <div class="modal-header">
      <h2 class="modal-title">Confirmer la suppression</h2>
      <button type="button" class="modal-close" onclick="hideClearCartModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p>Êtes-vous sûr de vouloir vider votre panier ? Cette action est irréversible.</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="modal-btn modal-btn-secondary" onclick="hideClearCartModal()">
        Annuler
      </button>
      <button type="button" class="modal-btn modal-btn-danger" onclick="confirmClearCart()">
        Vider le panier
      </button>
    </div>
  </div>
</div>

<!-- Container pour les toasts -->
<div class="toast-container" id="toast-container"></div>
<script>
// Variables globales
let cart = JSON.parse(localStorage.getItem('cart') || '[]');

// Fonctions Toast
function createToastContainer() {
  var container = document.getElementById('toast-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container';
    document.body.appendChild(container);
  }
  return container;
}

function showToast(message, type) {
  var container = createToastContainer();
  var toastId = 'toast-' + Date.now();
  
  var toastHtml = '<div id="' + toastId + '" class="toast toast-' + type + '">' +
    '<div class="toast-header">' +
      '<strong class="me-auto">' + (type === 'success' ? '✓ Succès' : '⚠ ' + (type === 'error' ? 'Erreur' : 'Info')) + '</strong>' +
      '<button type="button" class="toast-close" onclick="hideToast(\'' + toastId + '\')">&times;</button>' +
    '</div>' +
    '<div class="toast-body">' + message + '</div>' +
  '</div>';
  
  container.insertAdjacentHTML('beforeend', toastHtml);
  
  var toast = document.getElementById(toastId);
  
  setTimeout(function() {
    toast.classList.add('show');
  }, 100);
  
  setTimeout(function() {
    hideToast(toastId);
  }, 5000);
}

function hideToast(toastId) {
  var toast = document.getElementById(toastId);
  if (toast) {
    toast.classList.remove('show');
    setTimeout(function() {
      toast.remove();
    }, 300);
  }
}

// Fonction de nettoyage du panier - retire les items sans maxStock ou avec des données invalides
function cleanupCart() {
  var originalLength = cart.length;
  cart = cart.filter(function(item) {
    return item.priceId && 
           item.productName && 
           typeof item.price === 'number' && 
           typeof item.quantity === 'number' && 
           item.quantity > 0;
  });
  
  if (cart.length !== originalLength) {
    console.log('Panier nettoyé:', originalLength, '->', cart.length);
    localStorage.setItem('cart', JSON.stringify(cart));
  }
}

// Fonction d'affichage du panier
function updateCartDisplay() {
  cleanupCart(); // Nettoyer d'abord
  
  const emptyDiv = document.getElementById('cart-empty');
  const contentDiv = document.getElementById('cart-content');
  const itemsContainer = document.getElementById('cart-items');
  const totalElement = document.getElementById('cart-total');
  
  if (cart.length === 0) {
    emptyDiv.style.display = 'block';
    contentDiv.style.display = 'none';
    return;
  }
  
  emptyDiv.style.display = 'none';
  contentDiv.style.display = 'block';
  
  let total = 0;
  let html = '';
  
  cart.forEach(function(item, index) {
    const itemTotal = item.price * item.quantity;
    total += itemTotal;
    
    // Vérifier les limites de stock
    var stockStatus = '';
    var inputMax = 99;
    
    if (item.maxStock) {
      inputMax = item.maxStock;
      if (item.quantity > item.maxStock) {
        stockStatus = '<small class="text-danger">⚠ Quantité supérieure au stock (' + item.maxStock + ')</small>';
        // Corriger automatiquement
        item.quantity = item.maxStock;
      } else if (item.quantity === item.maxStock) {
        stockStatus = '<small class="text-warning">Stock maximum atteint</small>';
      }
    }
    
    html += '<div class="cart-item" id="cart-item-' + index + '">' +
      '<div class="item-info">' +
        '<h3>' + item.productName + '</h3>' +
        '<p class="item-price">' + item.price.toFixed(2) + ' € × ' + item.quantity + '</p>' +
        // (item.maxStock ? '<small class="text-muted">Stock disponible: ' + item.maxStock + '</small>' : '') +
        (stockStatus ? '<div class="stock-status">' + stockStatus + '</div>' : '') +
      '</div>' +
      '<div class="item-controls">' +
        '<input type="number" min="1" max="' + inputMax + '" value="' + item.quantity + '" ' +
               'onchange="updateQuantity(' + index + ', this.value)" ' +
               'id="quantity-' + index + '">' +
        '<span class="item-total">' + itemTotal.toFixed(2) + ' €</span>' +
        '<button onclick="removeItem(' + index + ')" class="btn btn-danger">×</button>' +
      '</div>' +
    '</div>';
  });
  
  itemsContainer.innerHTML = html;
  totalElement.textContent = total.toFixed(2) + ' €';
}

// Fonction de mise à jour de quantité avec vérification stock côté client
function updateQuantity(index, newQuantity) {
  var quantity = parseInt(newQuantity);
  var item = cart[index];
  
  console.log('Modification quantité:', {
    item: item.productName,
    oldQuantity: item.quantity,
    newQuantity: quantity,
    maxStock: item.maxStock
  });
  
  if (quantity <= 0) {
    removeItem(index);
    return;
  }
  
  // Vérifier le stock maximum si disponible
  if (item.maxStock && quantity > item.maxStock) {
    showToast('Stock insuffisant pour ' + item.productName + '. Maximum: ' + item.maxStock, 'error');
    // Remettre la valeur précédente dans l'input
    document.getElementById('quantity-' + index).value = item.quantity;
    return;
  }
  
  if (quantity > 99) {
    showToast('Quantité maximum: 99', 'warning');
    document.getElementById('quantity-' + index).value = item.quantity;
    return;
  }
  
  // Mise à jour de la quantité
  cart[index].quantity = quantity;
  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartDisplay();
  updateCartCount();
  
  // Notification si on atteint le stock max
  if (item.maxStock && quantity === item.maxStock) {
    showToast('Stock maximum atteint pour ' + item.productName, 'warning');
  }
}

// Fonction de suppression d'item
function removeItem(index) {
  var itemName = cart[index].productName;
  console.log('Suppression item:', itemName);
  
  cart.splice(index, 1);
  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartDisplay();
  updateCartCount();
  showToast(itemName + ' supprimé du panier', 'success');
}

// Fonctions modal
function showClearCartModal() {
  console.log('Ouverture de la modal clearCart');
  var modal = document.getElementById('clearCartModal');
  
  if (!modal) {
    console.error('Modal clearCartModal non trouvée !');
    return;
  }
  
  modal.classList.add('show');
  document.body.style.overflow = 'hidden';
}

function hideClearCartModal() {
  console.log('Fermeture de la modal clearCart');
  var modal = document.getElementById('clearCartModal');
  
  if (!modal) {
    console.error('Modal clearCartModal non trouvée !');
    return;
  }
  
  modal.classList.remove('show');
  document.body.style.overflow = '';
}

function confirmClearCart() {
  console.log('Confirmation: vider le panier');
  cart = [];
  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartDisplay();
  updateCartCount();
  hideClearCartModal();
  showToast('Panier vidé avec succès', 'success');
}

// Fonction de vérification des stocks avant checkout
function validateCartStock() {
  var hasIssues = false;
  var correctedItems = [];
  
  cart.forEach(function(item, index) {
    if (item.maxStock) {
      if (item.quantity > item.maxStock) {
        // Corriger automatiquement
        var oldQuantity = item.quantity;
        item.quantity = item.maxStock;
        correctedItems.push({
          name: item.productName,
          from: oldQuantity,
          to: item.maxStock
        });
        hasIssues = true;
      }
      
      if (item.maxStock <= 0) {
        // Produit en rupture de stock
        showToast('Produit en rupture: ' + item.productName, 'error');
        cart.splice(index, 1);
        hasIssues = true;
      }
    }
  });
  
  if (correctedItems.length > 0) {
    correctedItems.forEach(function(correction) {
      showToast('Quantité ajustée pour ' + correction.name + ': ' + correction.from + ' → ' + correction.to, 'warning');
    });
    
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartDisplay();
    updateCartCount();
  }
  
  return !hasIssues;
}

// Fonction de checkout avec vérification des stocks
async function checkoutCart() {
  if (cart.length === 0) {
    showToast('Votre panier est vide', 'warning');
    return;
  }
  
  const checkoutBtn = document.getElementById('checkout-btn');
  checkoutBtn.disabled = true;
  checkoutBtn.textContent = 'Vérification...';
  
  // Validation des stocks côté client
  var stockValid = validateCartStock();
  
  if (!stockValid) {
    showToast('Veuillez vérifier votre panier avant de continuer', 'error');
    checkoutBtn.disabled = false;
    checkoutBtn.textContent = 'Passer commande';
    return;
  }
  
  if (cart.length === 0) {
    // Le panier peut être vide après nettoyage
    checkoutBtn.disabled = false;
    checkoutBtn.textContent = 'Passer commande';
    return;
  }
  
  checkoutBtn.textContent = 'Préparation de la commande...';
  
  const lineItems = cart.map(function(item) {
    return {
      priceId: item.priceId,
      quantity: item.quantity
    };
  });
  
  console.log('Checkout avec:', lineItems);
  
  try {
    const response = await fetch('/.netlify/functions/create-checkout-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        lineItems: lineItems,
        successUrl: window.location.origin + '/success',
        cancelUrl: window.location.origin + '/cart'
      })
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error('Erreur serveur: ' + response.status + ' - ' + errorText);
    }
    
    const data = await response.json();
    
    if (data.url) {
      checkoutBtn.textContent = 'Redirection vers Stripe...';
      window.location.href = data.url;
    } else {
      throw new Error(data.error || 'URL de paiement non reçue');
    }
    
  } catch (error) {
    console.error('Erreur checkout:', error);
    showToast('Erreur lors de la commande: ' + error.message, 'error');
    checkoutBtn.disabled = false;
    checkoutBtn.textContent = 'Passer commande';
  }
}

// Fonction pour migrer les anciens items du panier sans maxStock
function migrateOldCartItems() {
  var needsMigration = false;
  
  cart.forEach(function(item) {
    if (!item.hasOwnProperty('maxStock')) {
      // Définir un stock par défaut pour les anciens items
      item.maxStock = 99;
      needsMigration = true;
      console.log('Migration item:', item.productName, 'stock par défaut: 99');
    }
  });
  
  if (needsMigration) {
    localStorage.setItem('cart', JSON.stringify(cart));
    showToast('Panier mis à jour avec la gestion des stocks', 'info');
  }
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
  console.log('Initialisation panier avec', cart.length, 'items');
  
  // Migration des anciens items
  migrateOldCartItems();
  
  // Affichage initial
  updateCartDisplay();
  
  // Configuration des événements de la modal
  var modal = document.getElementById('clearCartModal');
  
  if (modal) {
    // Clic sur l'overlay pour fermer
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        hideClearCartModal();
      }
    });
  }
  
  // Fermeture avec Échap
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      var modal = document.getElementById('clearCartModal');
      if (modal && modal.classList.contains('show')) {
        hideClearCartModal();
      }
    }
  });
  
  console.log('Panier initialisé');
});
</script>
{{ end }}