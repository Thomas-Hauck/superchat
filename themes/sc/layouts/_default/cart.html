{{ define "main" }}
<div class="cart-page">
  <div class="container-xxl single-txt">
    <h1 class="mb-5">Votre Panier</h1>
    
    <div id="cart-empty" class="empty-cart" style="display: none;">
      <p class="border-top-custom">Votre panier est vide</p>
      <a href="/shop" class="btn-global mt-5">Continuer mes achats</a>
    </div>
    
    <div id="cart-content" style="display: none;">
      <div id="cart-items"></div>
      
      <div class="cart-summary d-flex justify-content-end align-items-center">
        <div class="cart-total me-5">
          <strong>Total: <span id="cart-total">0.00 €</span></strong>
        </div>
        <div class="cart-actions">
          <button onclick="showClearCartModal()" class="btn-global-secondary">Vider le panier</button>
          <button onclick="checkoutCart()" class="btn-global">Passer commande</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Modal de confirmation pour vider le panier -->
<div id="clearCartModal" class="modal-overlay">
  <div class="modal-dialog">
    <div class="modal-header">
      <h2 class="modal-title">Confirmer la suppression</h2>
      <button type="button" class="modal-close" onclick="hideClearCartModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p>Êtes-vous sûr de vouloir vider votre panier ? Cette action est irréversible.</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="modal-btn btn-global-secondary modal-btn-secondary" onclick="hideClearCartModal()">
        Annuler
      </button>
      <button type="button" class="modal-btn btn-global modal-btn-danger" onclick="confirmClearCart()">
        Vider le panier
      </button>
    </div>
  </div>
</div>
<style>
.cart-page {
  min-height: 60vh;
  padding: 2rem 0;
}

.cart-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px dashed #000;
  margin-bottom: 1rem;
}
.cart-item .btn-danger {
    font-size: 2rem;
}
.btn-global-secondary{
    background-color: #727b77 ;
	color: #000 !important;
	padding: 3px 16px !important;
    border: none;
}
.item-info h3 {
  margin: 0 0 0.5rem 0;
}

.item-controls {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.item-controls input {
  width: 60px;
  padding: 0.5rem;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.item-price {
  font-weight: 400;
  color: #000;
  padding-bottom: 1rem !important;
}

.cart-summary {
  margin-top: 2rem;
}

.cart-actions {
  display: flex;
  gap: 1rem;
}


.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn:hover {
  opacity: 0.9;
}

.empty-cart {
  text-align: center;
}
.empty-cart p{
    padding-top: 16px;
}

@media (max-width: 768px) {
  .cart-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;
  }
  
  .cart-actions {
    flex-direction: column;
  }
}

/* Modal Overlay */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.modal-overlay.show {
  opacity: 1;
  visibility: visible;
}

/* Modal Container */
.modal-dialog {
  background: white;
  border-radius: 8px;
  max-width: 400px;
  width: 90%;
  margin: 0 20px;
  transform: scale(0.9);
  transition: transform 0.3s ease;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
  z-index: 10000; /* Z-index encore plus élevé */
  position: relative; /* Important pour le z-index */
  pointer-events: all; /* Force l'interactivité */
}

.modal-overlay.show .modal-dialog {
  transform: scale(1);
}

/* Modal Header */
.modal-header {
  padding: 1.5rem 1.5rem 0.5rem;
  border-bottom: 1px solid #e9ecef;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.modal-title {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 600;
  color: #212529;
}

.modal-close {
  background: none;
  border: none;
  font-size: 2rem;
  cursor: pointer;
  color: #6c757d;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  transition: background-color 0.2s;
}

.modal-close:hover {
  background-color: #f8f9fa;
  color: #000;
}

/* Modal Body */
.modal-body {
  padding: 1.5rem;
  color: #6c757d;
  font-size: 1.97rem;
}

/* Modal Footer */
.modal-footer {
  padding: 1rem 1.5rem 1.5rem;
  display: flex;
  gap: 0.75rem;
  justify-content: flex-end;
}

.modal-btn {
  padding: 0.5rem 1.5rem;
  border: 1px solid transparent;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1.97rem;
  transition: all 0.2s;
  min-width: 80px;
}

.modal-btn-secondary {
  background-color: #6c757d;
  color: white;
}

.modal-btn-secondary:hover {
  background-color: #5a6268;
}

.modal-btn-danger {
  background-color: #dc3545;
  color: white;
}

.modal-btn-danger:hover {
  background-color: #c82333;
}

/* Animation au clic pour éviter le double-clic accidentel */
.modal-btn:active {
  transform: scale(0.98);
}
</style>

<script>
// Gestion du panier
let cart = JSON.parse(localStorage.getItem('cart') || '[]');

function updateCartDisplay() {
  const emptyDiv = document.getElementById('cart-empty');
  const contentDiv = document.getElementById('cart-content');
  const itemsContainer = document.getElementById('cart-items');
  const totalElement = document.getElementById('cart-total');
  
  if (cart.length === 0) {
    emptyDiv.style.display = 'block';
    contentDiv.style.display = 'none';
    return;
  }
  
  emptyDiv.style.display = 'none';
  contentDiv.style.display = 'block';
  
  let total = 0;
  let html = '';
  
  cart.forEach((item, index) => {
    const itemTotal = item.price * item.quantity;
    total += itemTotal;
    
    html += `
      <div class="cart-item">
        <div class="item-info">
          <h2>${item.productName}</h2>
          <p class="item-price">${item.price.toFixed(2)} € × ${item.quantity}</p>
        </div>
        <div class="item-controls">
          <input type="number" min="1" value="${item.quantity}" 
                 onchange="updateQuantity(${index}, this.value)">
          <span class="item-total">${itemTotal.toFixed(2)} €</span>
          <button onclick="removeItem(${index})" class="btn btn-danger">×</button>
        </div>
      </div>
    `;
  });
  
  itemsContainer.innerHTML = html;
  totalElement.textContent = total.toFixed(2) + ' €';
}

function updateQuantity(index, newQuantity) {
  const quantity = parseInt(newQuantity);
  if (quantity > 0) {
    cart[index].quantity = quantity;
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartDisplay();
  }
}

function removeItem(index) {
  cart.splice(index, 1);
  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartDisplay();
}

// Nouvelle fonction pour afficher la modal
function showClearCartModal() {
  var modal = document.getElementById('clearCartModal');
  modal.classList.add('show');
  
  // Empêcher le scroll de la page en arrière-plan
  document.body.style.overflow = 'hidden';
}

// Fonction pour masquer la modal
function hideClearCartModal() {
  var modal = document.getElementById('clearCartModal');
  modal.classList.remove('show');
  
  // Réactiver le scroll
  document.body.style.overflow = '';
}

// Fonction de confirmation pour vider le panier
function confirmClearCart() {
  cart = [];
  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartDisplay();
  hideClearCartModal();
  
  // Optionnel : afficher une notification de succès
  showToast('Panier vidé avec succès', 'success');
}

// Fermeture de la modal en cliquant sur l'overlay
document.addEventListener('DOMContentLoaded', function() {
  var modal = document.getElementById('clearCartModal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        hideClearCartModal();
      }
    });
  }
  
  // Fermeture avec la touche Échap
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      hideClearCartModal();
    }
  });
});

async function checkoutCart() {
  if (cart.length === 0) return;
  
  const lineItems = cart.map(item => ({
    priceId: item.priceId,
    quantity: item.quantity
  }));
  
  try {
    const response = await fetch('/.netlify/functions/create-checkout-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        lineItems: lineItems,
        successUrl: `${window.location.origin}/success`,
        cancelUrl: `${window.location.origin}/cart`
      })
    });
    
    const data = await response.json();
    if (data.url) {
      window.location.href = data.url;
    } else {
      alert('Erreur lors de la création de la session de paiement');
    }
  } catch (error) {
    console.error('Erreur:', error);
    alert('Une erreur est survenue');
  }
}

// Initialiser l'affichage au chargement
document.addEventListener('DOMContentLoaded', function() {
  updateCartDisplay();
});
</script>
{{ end }}