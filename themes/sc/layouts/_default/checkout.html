{{ define "main" }}
<div class="checkout-container">
  <div class="product-summary">
    <h2>{{ .Title }}</h2>
    <p>{{ .Params.description }}</p>
    <div class="price">{{ .Params.price }}€</div>
  </div>

  <div class="payment-form-container">
    <form id="checkout-form">
      <div id="payment-element">
        <!-- Les éléments Stripe seront insérés ici -->
      </div>
      
      <div id="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Chargement...</p>
      </div>
      
      <button id="pay-button" type="submit">
        Payer {{ .Params.price }}€
      </button>
      
      <div id="payment-message" style="display: none;"></div>
    </form>
  </div>
</div>

<!-- Données pour JavaScript -->
<div 
  data-price="{{ .Params.price }}"
  data-product-name="{{ .Title }}"
  data-product-description="{{ .Params.description }}"
  style="display: none;"
></div>
{{ end }}

{{ define "head" }}
<meta name="stripe-public-key" content="{{ site.Params.stripe.publicKey }}">
<script src="https://js.stripe.com/v3/"></script>
<link rel="stylesheet" href="/css/checkout.css">
{{ end }}

{{ define "footer" }}
<script src="/js/stripe-integration.js"></script>
<script>
// Script inline spécifique à cette page
document.addEventListener('DOMContentLoaded', async function() {
  const checkoutForm = document.getElementById('checkout-form');
  const payButton = document.getElementById('pay-button');
  const loadingSpinner = document.getElementById('loading');
  
  // Configuration depuis Hugo
  const stripePublicKey = document.querySelector('meta[name="stripe-public-key"]')?.content;
  if (!stripePublicKey) {
    console.error('Clé publique Stripe manquante');
    showMessage('Configuration Stripe manquante', true);
    return;
  }

  // Récupération du paramètre 'shop' depuis l'URL
  const urlParams = new URLSearchParams(window.location.search);
  const shopSlug = urlParams.get('shop');
  
  if (!shopSlug) {
    showMessage('Produit non spécifié', true);
    return;
  }

  const checkout = new StripeCheckout(stripePublicKey);

  // Récupérer les données de produit depuis la page
  const productData = {
    amount: parseFloat(document.querySelector('[data-price]')?.dataset.price || '0'),
    name: document.querySelector('[data-product-name]')?.dataset.productName || '',
    description: document.querySelector('[data-product-description]')?.dataset.productDescription || ''
  };

  if (productData.amount <= 0) {
    checkout.showMessage('Prix du produit invalide', true);
    return;
  }

  try {
    loadingSpinner.style.display = 'block';
    await checkout.initialize(productData.amount, {
      shop_slug: shopSlug,
      shop_name: productData.name,
      shop_description: productData.description
    });
    loadingSpinner.style.display = 'none';
  } catch (error) {
    console.error('Erreur:', error);
    checkout.showMessage('Erreur lors du chargement du paiement', true);
    loadingSpinner.style.display = 'none';
  }

  // Gestion de la soumission du formulaire
  checkoutForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    payButton.disabled = true;
    payButton.textContent = 'Traitement...';

    try {
      const returnUrl = `${window.location.origin}/success`;
      await checkout.confirmPayment(returnUrl);
    } catch (error) {
      checkout.showMessage(error.message, true);
      payButton.disabled = false;
      payButton.textContent = 'Payer maintenant';
    }
  });

  // Fonction utilitaire pour afficher les messages
  function showMessage(message, isError = false) {
    const messageContainer = document.getElementById('payment-message');
    if (messageContainer) {
      messageContainer.textContent = message;
      messageContainer.className = isError ? 'error' : 'success';
      messageContainer.style.display = 'block';
    }
  }
});
</script>
{{ end }}